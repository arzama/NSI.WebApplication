<div role="main">
    <div class="">

        <div class="page-title">
            <div class="title_left">
                <h3>Inbox
                    <i class="fa fa-inbox"></i>
                </h3>
            </div>

            <div class="title_right">
                <div class="col-md-5 col-sm-5 col-xs-12 form-group pull-right top_search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search for...">
                        <span class="input-group-btn">
                            <button class="btn btn-default" type="button">Go!</button>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="clearfix"></div>

        <div class="row">
            <div class="col-md-12">
                <div class="x_panel">
                    <div class="x_title">

                        <h2>User Messages</h2>

                        <ul class="nav navbar-right panel_toolbox">

                            <li>
                                <button class="btn btn-toolbar chatActions" (click)='createNewConversation()'> New message
                                    <i class="fa fa-pencil-square-o"></i>
                                </button>
                            </li>

                        </ul>
                        <div class="clearfix"></div>
                    </div>


                    <div class="x_content">
                        <div class="row"></div>

                        <div class="col-sm-3 mail_list_column" *ngIf='_conversations && _conversations.length'>

                            <a class="conversationSide" *ngFor='let conversation of _conversations' (click)='loadMessages(conversation.conversationId)'>
                                <input type='hidden' value="{{conversation.conversationId}}">
                                <div class="mail_list">

                                    <h3> {{ conversation.conversationName }}
                                        <small *ngIf='conversation.message && conversation.message.length > 0'> {{conversation.message[conversation.message.length -1 ].dateCreated | date : 'dd/MM/yyyy
                                            HH:mm'}}
                                        </small>
                                    </h3>
                                    
                                    <p *ngIf='conversation.message && conversation.message.length > 0'>
                                        <span *ngIf="conversation.message[conversation.message.length -1].message.includes('!!!INFO!!!'); else normalLastMessage">
                                                {{conversation.message[conversation.message.length -1 ].message | slice:10 | slice:0:29 }}...
                                        </span>
                                        <ng-template #normalLastMessage>
                                            <p *ngIf="conversation.message[conversation.message.length - 1].message.length > 30; else fullMessage" [innerHTML] = " conversation.message[conversation.message.length - 1].message | slice:0:29 | appendDots" >                                               
                                                
                                            </p>  
                                            <ng-template #fullMessage>
                                                <p [innerHTML]="conversation.message[conversation.message.length - 1].message"></p>
                                            </ng-template>                                                                                      
                                        </ng-template>                                 
                                        
                                    </p>

                                </div>
                            </a>

                        </div>
                        <!-- /MAIL LIST -->

                        <!-- CONTENT MAIL -->
                        <div class="col-sm-9 mail_view">
                            <div class="inbox-body">
                                <div class="row" *ngIf="!isNewMessageClicked && !onStart">
                                    <span *ngIf="_participants?.length > 2" class="left convParts">
                                        <i class="fa fa-users"></i>
                                        <span *ngFor='let p of _participants; let first = first; let last = last;'>
                                            <span *ngIf='!first && !last'>,</span>
                                            <span *ngIf="last">
                                                <strong>
                                                    <em>and</em>
                                                </strong>
                                            </span>
                                            <strong>
                                                <em>{{p?.user.firstName}}</em>
                                            </strong>
                                        </span>
                                    </span>
                                    <ul class="nav navbar-right panel_toolbox">
                                        <li>
                                            <button class="btn btn-toolbar chatActions" (click)='prepareforAdding()'> Add participant(s)
                                                <i class="fa fa-user"></i>
                                            </button>
                                        </li>

                                        <li>
                                            <button class="btn btn-toolbar chatActions"> Delete conversation
                                                <i class="fa fa-remove"></i>
                                            </button>
                                        </li>
                                    </ul>

                                </div>
                                <div class="row input-group col-md-12" *ngIf='isNewMessageClicked'>


                                    <angular2-multiselect [data]="dropdownList" [(ngModel)]="selectedItems" [settings]="dropdownSettings" (onSelect)="onItemSelect($event)"
                                        (onDeSelect)="OnItemDeSelect($event)" (onSelectAll)="onSelectAll($event)" (onDeSelectAll)="onDeSelectAll($event)"></angular2-multiselect>

                                    <div class="col-md-6">
                                        <input class=" convName form-control btn-md" type="text" placeholder="Conversation name..." [(ngModel)]="newConversationName"
                                            *ngIf='isGroupConversation()'>
                                        <input type="button" class='btn btn-md btn-success ' value='Create conversation' (click)="createConversation()" [disabled]='!validateCreateConversation()'>
                                    </div>

                                </div>
                                <div class="separator"></div>
                                <div>
                                    <div class="view-mail scroller" #scrollMe [scrollTop]='scrollMe.scrollHeight' *ngIf='messageListSelectedConversation && messageListSelectedConversation.length'>
                                        <p class="conversationCreatorTop">Conversation created by {{ conversationCreatedBy }}</p>
                                        <div class="row" *ngFor='let m of messageListSelectedConversation'>
                                            
                                            <div *ngIf="m.message.includes('!!!INFO!!!'); else normalMessage">
                                                <p class="conversationCreatorTop"><i class="glyphicon glyphicon-user"></i>{{m.message | slice:10}}</p>
                                            </div>
                                            <ng-template #normalMessage>
                                                <p class="position-left" [class.position-right]="isMessageSender(m.createdByUser.id,loggedUserId)" [innerHTML] = "m.message" >
                                                
                                                </p>
    
                                                <br>
                                                <div class="clearfix"></div>
                                                <span style="margin-left:200px" *ngIf='!isMessageSender(m.createdByUser.id,loggedUserId)'>
                                                    <small>{{m.createdByUser.userName}}</small>
                                                    <span *ngIf='checkIfUserIsOnline(m.createdByUser.id)'>
                                                        <i tooltip ngToolTipClass="tooltipClass" content="User is online." class="online glyphicon glyphicon-user"></i>
                                                    </span>
                                                </span>
                                            </ng-template>                                            
                                        </div>
                                    </div>

                                    <div class="separator"></div>

                                    <div class="col-md-12 col-sm-12 col-xs-12" *ngIf="!isNewMessageClicked && !onStart">
                                        <div *ngIf='whosTyping && whosTyping.length > 0 && typingConvId == activeConversationId'>
                                            <i class="fa fa-spin fa-spinner"></i>
                                            <input type="text" class="typing" [(ngModel)]="whosTyping">
                                        </div>

                                        <textarea class="col-md-9 col-sm-9 col-xs-9 resizeable_textarea" (keypress)="keyPressEventHandler($event)" placeholder="New message..."
                                            [(ngModel)]="newMessage"></textarea>

                                        <button class="btn btn-success" (click)="sendMessage()" [disabled]='!validateNewMessageLength()'>Send
                                            <i class="fa fa-send-o"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- modal for adding participants to conversation !-->
    <div class="modal fade bs-example-modal-lg" id="myModal" tabindex="-1" role="dialog" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title">Add participant(s) to conversation</h4>
                </div>
                <div class="modal-body col-md-12">
                    <div class="col-md-2"></div>
                    <div class="col-md-8">
                        <div class="jumbotron">
                            <span style="text-align: justify;">
                                <strong>
                                    <em>Note:</em>
                                </strong> Adding a participant(s) to direct message conversation (2 existing participants) will result
                                in creating a new group conversation. However, conversations that possess more than 2 existing
                                participants will have chosen participant(s) appended to the list of participants. Therefore,
                                new participant(s) will have insight on the previous messages of conversation. If you would
                                like to avoid this scenario, consider creating a new group conversation.</span>
                        </div>
                        <input type="text" class="form-control" style="width: 100%; margin:auto;" *ngIf="directMessageAP" placeholder="Conversation name..." [(ngModel)]="newConversationNameAP">
                        <div class="separator"></div>
                        <angular2-multiselect style="width: 100%;" [data]="dropdownListAP" [(ngModel)]="selectedItemsAP" [settings]="dropdownSettings"
                            (onSelect)="onItemSelectAP($event)" (onDeSelect)="OnItemDeSelectAP($event)" (onSelectAll)="onSelectAllAP($event)"
                            (onDeSelectAll)="onDeSelectAllAP($event)"></angular2-multiselect>
                        
                    </div>
                    <div class="col-md-2"></div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-success" [disabled]='!validateCreateConversationAP()' (click)="addNewParticipant()">Add</button>
                </div>
            </div>
        </div>
    </div>